<%-include('../layouts/user/header')-%>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <!-- Add this script tag to include jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>


    </head>

    <body>
        <div class="page-wrapper">
            <%-include('../layouts/user/navbar')-%>

                <main class="main">
                    <div class="page-header text-center"
                        style="background-image: url('/assets/images/page-header-bg.jpg')">
                        <div class="container">
                            <h1 class="page-title">My Account<span>Frost-Bay</span></h1>
                        </div><!-- End .container -->
                    </div><!-- End .page-header -->
                    <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
                        <div class="container">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                                <li class="breadcrumb-item"><a href="#">Shop</a></li>
                                <li class="breadcrumb-item active" aria-current="page">My Account</li>
                            </ol>
                        </div><!-- End .container -->
                    </nav><!-- End .breadcrumb-nav -->



                    <div class="page-content">
                        <div class="dashboard">
                            <div class="container">
                                <div class="row">
                                    <aside class="col-md-4 col-lg-3">
                                        <ul class="nav nav-dashboard flex-column mb-3 mb-md-0" role="tablist">
                                            <li class="nav-item">
                                                <a class="nav-link active" id="tab-orders-link" data-toggle="tab"
                                                    href="#tab-orders" role="tab" aria-controls="tab-orders"
                                                    aria-selected="false">Orders</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link " id="tab-dashboard-link" data-toggle="tab"
                                                    href="#tab-dashboard" role="tab" aria-controls="tab-dashboard"
                                                    aria-selected="true">Edit profile</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" id="tab-address-link" data-toggle="tab"
                                                    href="#tab-address" role="tab" aria-controls="tab-address"
                                                    aria-selected="false">Adresses</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" id="tab-wallet-link" data-toggle="tab"
                                                    href="#tab-wallet" role="tab" aria-controls="tab-wallet"
                                                    aria-selected="false">Wallet</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" id="tab-coupons-link" data-toggle="tab"
                                                    href="#tab-coupons" role="tab" aria-controls="tab-coupons"
                                                    aria-selected="false">My coupons</a>
                                            </li>
                                            <li class="nav-item">

                                                <a class="nav-link" onclick="confirmLogout()" href="/logout">Sign
                                                    Out</a>
                                            </li>
                                        </ul>
                                    </aside><!-- End .col-lg-3 -->

                                    <div class="col-md-8 col-lg-9">
                                        <div class="tab-content">
                                            <div class="tab-pane fade " id="tab-dashboard" role="tabpanel"
                                                aria-labelledby="tab-dashboard-link">
                                                <!-- Content specific to the Edit Profile tab -->
                                                <form class="form" action="/account/editUser" method="post"
                                                    id="editform" enctype="multipart/form-data">
                                                    <div class="d-flex flex-column align-items-center">
                                                        <div class="profile-image-container">
                                                            <img id="profileImage"
                                                                src="/assets/userImages/croppedImages/<%= user.userImage %>"
                                                                class="avatar img-circle img-thumbnail" alt="avatar">
                                                        </div>
                                                        <label for="fileInput" class="change-profile-label">
                                                            <i>Change profile image</i>
                                                            <i class="fa-solid fa-pen fa-sm d-inline-block"
                                                                style="color: #cc9966;"></i>
                                                        </label>
                                                        <input type="file" name="userImage" id="fileInput" class=""
                                                            style="display:none;" onchange="displayImage()">
                                                    </div>


                                                    <!-- -------Form----- -->
                                                    <div class="tab-content">
                                                        <div class="tab-pane active" id="home">
                                                            <hr>

                                                            <!-- Name Field -->
                                                            <div class="form-row">
                                                                <div class="form-group col-md-6">
                                                                    <label for="name">
                                                                        <h6>Name</h6>
                                                                    </label>
                                                                    <input type="text" value="<%= user.name %>"
                                                                        class="form-control m-0" id="name" name="name"
                                                                        placeholder="Enter name">
                                                                    <p class="m-0 text-danger" id="nameError"></p>
                                                                </div>

                                                                <!-- Email Field -->
                                                                <div class="form-group col-md-6">
                                                                    <label for="email">
                                                                        <h6>Email</h6>
                                                                    </label>
                                                                    <input type="" value="<%= user.email %>"
                                                                        class="form-control m-0" id="email" name="email"
                                                                        placeholder="you@email.com" disabled>
                                                                    <p class="m-0 text-danger" id="emailError"></p>
                                                                </div>
                                                            </div>

                                                            <!-- Phone Field -->
                                                            <div class="form-row">
                                                                <div class="form-group col-md-6">
                                                                    <label for="phone">
                                                                        <h6>Phone</h6>
                                                                    </label>
                                                                    <input type="text" value="<%= user.phone %>"
                                                                        class="form-control m-0" id="phone" name="phone"
                                                                        placeholder="Enter phone">
                                                                    <p class="m-0 text-danger" id="phoneError"></p>
                                                                </div>

                                                                <!-- Location Field -->
                                                                <div class="form-group col-md-6">
                                                                    <label for="location">
                                                                        <h6>Location</h6>
                                                                    </label>
                                                                    <select id="location" name="location"
                                                                        class="form-control">
                                                                        <option value="Kerala" <% if
                                                                            (user.location==='Kerala' ) { %> selected
                                                                            disabled <% } %>>Kerala</option>
                                                                        <option value="Banglore" <% if
                                                                            (user.location==='Banglore' ) { %> selected
                                                                            disabled <% } %>>Banglore</option>
                                                                        <option value="Chennai" <% if
                                                                            (user.location==='Chennai' ) { %> selected
                                                                            disabled <% } %>>Chennai</option>
                                                                        <option value="Kochi" <% if
                                                                            (user.location==='Kochi' ) { %> selected
                                                                            disabled <% } %>>Kochi</option>
                                                                    </select>
                                                                </div>
                                                            </div>

                                                            <div>
                                                                <i class="fa-solid fa-unlock fa-sm"
                                                                    style="color: #cc9966;"></i>
                                                                <p for="fileInput" class="change-profile-label"><i>
                                                                        Reset Password ?</i></p>
                                                            </div>

                                                            <!-- Validation Error Messages -->
                                                            <div id="errorMessages" class="text-danger"></div>

                                                            <!-- Submit Button -->
                                                            <div class="form-group d-flex flex-column align-items-end">
                                                                <div class="col-xs-12">
                                                                    <br>
                                                                    <button class="btn btn-lg btn-success"
                                                                        type="submit">Save</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                                <hr>
                                            </div><!--/tab-pane-->


                                            <div class="tab-pane fade show active" id="tab-orders" role="tabpanel"
                                                aria-labelledby="tab-orders-link">
                                                <h5 class="text-center">Orders</h5>
                                                <% if(orders.length>0){ %>
                                                    <table class="table table-wishlist table-no-padding">
                                                        <thead>
                                                            <tr>
                                                                <th></th>
                                                                <th></th>
                                                                <th></th>
                                                                <th></th>
                                                                <th></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% orders.forEach(function(order) {
                                                                order.orderedProducts.forEach(function(product) { 
                                                                    order.shipAddress.forEach(address =>{ %>
                                                                    <tr class="text-center" data-order-details="<%= JSON.stringify(order) %>">
                                                                    <td class="p-0">
                                                                        <div class="">
                                                                            <figure class="d-inline-block">
                                                                                <a href="#">
                                                                                    <div class="p-2"
                                                                                        style="height:60px ; width: 60px;">
                                                                                        <img src="/assets/productImages/uploadImages/<%= product.productDetails.productImage%>"
                                                                                            alt="<%= product.productDetails.name %>">
                                                                                    </div>

                                                                            </figure>
                                                                        </div>
                                                                        <h6></h6>
                                                                    </td>
                                                                <td class="product-name" style="cursor: pointer;"
                                                                        data-toggle="modal"
                                                                        data-target="#orderDetailsModal"
                                                                        data-product-image="<%= product.productDetails.productImage%>"
                                                                        data-product-quantity="<%= product.quantity %>"
                                                                        data-product-name="<%= product.productDetails.name %>"
                                                                        data-purchase-date="<%= order.purchaseDate %>"
                                                                        data-total-amount="<%= order.totalAmount %>"
                                                                        data-payment-method="<%= order.paymentMethod %>"
                                                                        data-status="<%= product.status %>"
                                                                        data-product-amount="<%= product.productDetails.price %>"
                                                                        data-name="<%= address.name %>"
                                                                        data-house-name="<%= address.houseName %>"
                                                                        data-zipcode="<%= address.zipcode %>"
                                                                        data-phone="<%= address.phone %>"
                                                                        data-status-update-date="<%= product.stausUpdatedDate %>"
                                                                        
                                                                        ">
                                                                        
                                                                        <h6>
                                                                            <%= product.productDetails.name %>
                                                                        </h6>
                                                                    </td>


                                                                    <td id="status">
                                                                        <% if(product.status=="Placed" ){ %>
                                                                            <p class="rounded" id="placed">
                                                                                <%= product.status %>
                                                                            </p>
                                                                            <% } else if(product.status=="On the way" ){
                                                                                %>
                                                                                <p class="rounded" id="onTheWay">
                                                                                    <%= product.status %>
                                                                                </p>
                                                                                <% } else if(product.status=="Refunded"
                                                                                    ){ %>
                                                                                    <p class="rounded" id="refund">
                                                                                        <%= product.status %>
                                                                                    </p>
                                                                                    <% } else
                                                                                        if(product.status=="Cancelled"
                                                                                        ){ %>
                                                                                        <p class="rounded"
                                                                                            id="cancelled">
                                                                                            <%= product.status %>
                                                                                        </p>
                                                                                        <% } else
                                                                                            if(product.status=="Delivered"
                                                                                            ){ %>
                                                                                            <p class="rounded"
                                                                                                id="delivered">
                                                                                                <%= product.status %>
                                                                                            </p>
                                                                                            <% } else { %>
                                                                                                <p class="text-primary">
                                                                                                    <%= product.status
                                                                                                        %>
                                                                                                </p>
                                                                                                <% } %>
                                                                    </td>

                                                                    <td>
                                                                        <span class="text-info">
                                                                            On <%= product.stausUpdatedDate %>
                                                                        </span>
                                                                    </td>
                                                                    <td class="">
                                                                        <% const now=new Date(); const
                                                                            purchaseDateTime=new
                                                                            Date(`${order.purchaseDate}
                                                                            ${order.purchaseTime}`); const
                                                                            timeDifference=(now - purchaseDateTime) /
                                                                            (1000 * 60); const
                                                                            minutesDifference=Math.floor(timeDifference);
                                                                            if (product.status==="Placed" ) { %>
                                                                            <a class="text-danger"
                                                                                style="cursor: pointer;"
                                                                                onclick="cancelOrder('<%= product.productId %>','<%= order._id %>')">Cancel</a>
                                                                            <% } else if (product.status==="Delivered"
                                                                                && minutesDifference <=1440) { %>
                                                                                <a class="text-primary"
                                                                                    id="requestStatus"
                                                                                    style="cursor: pointer;"
                                                                                    onclick="refundRequest('<%= order._id %>','<%= product.productId %>')">Refund
                                                                                    request <i
                                                                                        class="fa-sharp fa-solid fa-rotate-left"
                                                                                        style="color: #cc9966;"></i></a>
                                                                                <% } %>
                                                                </tr>
                                                                <% }); %>
                                                                <% }); %>

                                                                    <% }); %>
                                                                        <!-- Add more rows as needed -->
                                                        </tbody>
                                                    </table>
                                                    <% }else{%>

                                                        <div class="d-flex flex-column  align-items-center">
                                                            <div>
                                                                <h5 style="color: gray;">OOPS!..Nothing is here</h5>
                                                            </div>
                                                            <div>
                                                                <a href="/shop"
                                                                    class=" btn btn-secondary position-relative">Shop</a>
                                                            </div>

                                                        </div>
                                                        <% } %>
                                                            <!-- End .table table-wishlist -->
                                            </div>


                                            <!-- -------------Modal for Order Details-------------- -->
                                            <div class="modal fade" id="orderDetailsModal" tabindex="-1" role="dialog" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
                                                <div class="modal-dialog" role="document">
                                                    <div class="modal-content">
                                                        <div class="text-center flex-column justify-content-center p-3 pb-0" style="background-color: #a47a51;">
                                                            <h4 class="modal-title mx-auto text-white" id="orderDetailsModalLabel">Order Details</h4>
                                                            <p class="text-center text-white"><span id="modal-purchase-date"></span></p>
                                                            <span class="badge rounded-pill modal-status" style="background-color: #97ff975f; color: #08ff3f;"></span>
                                                            <button type="button" class="close m-0 position-absolute text-white" style="right: 1rem; top: 1rem;" data-dismiss="modal" aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body m-4">
                                                            <div class="row justify-content-between mx-4">
                                                                <h6>Product</h6>
                                                                <h6>Sub total</h6>
                                                            </div>
                                                            <div class="row mx-2">
                                                                <div class="d-flex align-items-center w-100">
                                                                    <div class="product-image" style="width: fit-content;">
                                                                        <img id="modal-product-image" style="width: 8rem;" class="m-0" src="" alt="Product Image">
                                                                    </div>
                                                                    <p class="ml-5">
                                                                        <span id="modal-product-quantity"></span> X
                                                                        <span id="modal-product-name"></span>
                                                                    </p>
                                                                    <div class="flex-grow-1"></div>
                                                                    <p class="mr-4 pr-3">₹<span id="modal-product-amount"></span></p>
                                                                </div>
                                                            </div>
                                                            <hr>
                                                            <div class="row justify-content-between">
                                                                <div class="col-md-6">
                                                                    <p class="text-dark">Payment method</p>
                                                                    <p class="text-dark">Coupon</p>
                                                                    <p class="text-dark">Offer</p>
                                                                </div>
                                                                <div class="col-md-6" style="text-align: end;">
                                                                    <p id="modal-payment-method"></p>
                                                                    <p class="text-success pr-3" id="modal-coupon-info" ><strike>-₹345</strike></p>
                                                                    <p class="text-primary pr-4" id="modal-offer-info"><b>10%</b></p>
                                                                </div>
                                                            </div>
                                                            <hr class="m-2 mb-2">
                                                            <div class="row justify-content-between">
                                                                <div class="col-md-6">
                                                                    <h6 class="text-dark"> Total order amount</h6>
                                                                </div>
                                                                <div class="col-md-6" style="text-align:end;">
                                                                    <h6>₹<span id="modal-total-amount"></span></h6>
                                                                </div>
                                                            </div>
                                                            <div class="d-flex justify-content-between card flex-row align-items-center">
                                                                <div class="col-md-6 p-0">
                                                                    <p><b><u>Shipping address</u></b></p>
                                                                    <p class="text-dark"><span id="modal-name"></span><br>
                                                                        <span id="modal-house-name"></span><br>
                                                                        <span id="modal-zipcode"></span>,
                                                                        <span id="modal-phone"></span></p>
                                                                </div>
                                                                <div class="col-md-6 p-0" style="text-align: end;">
                                                                    <p class="text-primary" ><span class="modal-status"></span> on <span id="modal-status-update-date"> </span></p>

                                                                </div>  
                                                            </div>
                                                            <div class="text-center"> 
                                                                <button class="btn btn-outline-primary-2 rounded-pill p-2 btn-print">Print <i class="fa-solid fa-file-invoice"></i> </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            

                                            <!-- -------------------------------Modal for refund request------------------------------ -->
                                            <div class="modal fade" id="refundRequestModal" tabindex="-1" role="dialog"
                                                aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
                                                <div class="modal-dialog" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="orderDetailsModalLabel">
                                                                Refund
                                                                request</h5>
                                                            <button type="button" class="close" data-dismiss="modal"
                                                                aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body m-3">
                                                            <p style="color: #0a9538;font-style: italic;">Honesty
                                                                Appreciated: We believe you! Get your full refund
                                                                with no fuss. Just share a pic & reason, and your
                                                                next
                                                                slice
                                                                comes with a sweet discount. Cheers!</p>
                                                            <form action="" class="m-3">
                                                                <label for="">Cake image(damage) <span
                                                                        class="text-danger">*</span></label>
                                                                <div class="row justify-content-center">
                                                                    <div class="col-md-6"
                                                                        style="text-align:-webkit-center; border: 1px solid #ccc;">
                                                                        <input type="file"
                                                                            class="h-100 position-absolute "
                                                                            style="left: 0;opacity: 0;"
                                                                            name="damageCakeImage" required>
                                                                        <img src="/assets/images/icons/imageUploader.png"
                                                                            alt="" class="img-fluid">
                                                                        <p>Upload your cake image</p>

                                                                    </div>
                                                                    <div class="col-md-6 ">
                                                                        <textarea class="pl-2 w-100 h-100"
                                                                            name="reasonNote" id=""
                                                                            placeholder="Drop your reason here..."
                                                                            required></textarea>
                                                                    </div>
                                                                    <button type="submit"
                                                                        class="btn btn-primary mt-2">Send
                                                                        request</button>
                                                                </div>

                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>


                                            <div class="tab-pane fade" id="tab-address" role="tabpanel"
                                                aria-labelledby="tab-address-link">
                                                <div id="addressTab">
                                                    <div class="d-flex justify-content-end">
                                                        <p>
                                                            <button class="text-dark border-0 shadow"
                                                                data-toggle="modal" data-target="#addAddressModal">
                                                                <i class="fa-sharp fa-solid fa-circle-plus"
                                                                    style="color: #2bc752;"></i> Add address
                                                            </button>
                                                        </p>
                                                    </div>
                                                    <div class="row justify-content-center">
                                                        <% for( let i=0 ; i < address.length ; i++) { %>
                                                            <div class="col-lg-6">
                                                                <div class="card card-dashboard shadow">
                                                                    <!-- Add the shadow class to the card -->
                                                                    <div class="card-body pr-0 py-0">
                                                                        <h3 class="card-title d-inline">Address <%= i+1
                                                                                %>
                                                                                <%if(address[i].default==true){%>
                                                                                    <span class="text-info"
                                                                                        style="font-size: x-small;">default</span>
                                                                                    <%}%>
                                                                        </h3>
                                                                        <button class="float-right delete p-0"><i
                                                                                class="fas fa-trash"
                                                                                onclick="showConfirmationModal('<%= address[i]._id %>')"></i></button>
                                                                        <p class="m-0">
                                                                            <%= address[i].name %><br>
                                                                                <%= address[i].company %>
                                                                                    <%= address[i].houseName %> <br>
                                                                                        <%= address[i].appartmentNumber
                                                                                            %>,
                                                                                            <%=address[i].city %>
                                                                                                <br>
                                                                                                <%= address[i].state%>
                                                                                                    ,
                                                                                                    <%=address[i].country
                                                                                                        %>
                                                                                                        <br>
                                                                                                        <%=
                                                                                                            address[i].zipcode%>
                                                                                                            <br>
                                                                                                            <%=
                                                                                                                address[i].email%>
                                                                                                                <br>
                                                                                                                <%=address[i].phone%>
                                                                                                                    <br>
                                                                                                                    <a href="#"
                                                                                                                        onclick="showEditAddressModal('<%= address[i].name %>','<%= address[i].company %>','<%= address[i].country %>', '<%= address[i].houseName %>', '<%= address[i].appartmentNumber %>', '<%= address[i].city %>', '<%= address[i].state %>', '<%= address[i].zipcode %>', '<%= address[i].phone %>', '<%= address[i].email %>','<%= address[i]._id %>','<%= address[i].default %>')">Edit
                                                                                                                        <i class="fa-sharp fa-solid fa-pen"
                                                                                                                            style="color: #cc9966;"></i></a>
                                                                        </p>
                                                                    </div><!-- End .card-body -->
                                                                </div><!-- End .card-dashboard -->
                                                            </div><!-- End .col-lg-6 -->
                                                            <%}%>
                                                    </div>
                                                    <% if(address.length < 1){ %>
                                                        <h6 style="color: gray;" class="text-center">No addresses..!
                                                        </h6>
                                                        <%}%>
                                                </div>
                                            </div>


                                            <div class="tab-pane fade" id="tab-wallet" role="tabpanel"
                                                aria-labelledby="tab-wallet-link">
                                                <div class="card card-dashboard m-0 shadow-lg"
                                                    style="background-image: url(/assets/images/banners/Wallet\ Banner.png.webp);">
                                                    <h3 class="text-light ls-3" style="margin: 6rem;">Wallet</h3>
                                                </div>
                                                <div class="card card-dashboard p-4 shadow">
                                                    <h5 style="color: grey;">Wallet amount : <span class="text-dark">₹
                                                            <%= user.wallet.balance %>.00
                                                        </span></h5>

                                                    <!-- <h5><%= user.wallet %></h5> -->
                                                    <a href="" class="" style="color: gray;"><i
                                                            class="fa-regular fa-square-plus  fa-la pr-2"
                                                            style="color: #cc9966;"></i>Add money to wallet</a>
                                                    <a href="#" class="" style="color: gray;" data-toggle="modal"
                                                        data-target="#transationDetailsModal" <i
                                                        class="fa-solid fa-clock-rotate-left fa-la"
                                                        style="color: #cc9966;"></i> Transaction history
                                                    </a>
                                                </div>
                                            </div>


                                            <!-- -------------Modal for Transation  historys-------------- -->
                                            <div class="modal fade" id="transationDetailsModal" tabindex="-1"
                                                role="dialog" aria-labelledby="orderDetailsModalLabel"
                                                aria-hidden="true">
                                                <div class="modal-dialog" role="document">
                                                    <div class="modal-content" style="background-color: antiquewhite;">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="orderDetailsModalLabel">
                                                                Transaction history</h5>
                                                            <button type="button" class="close" data-dismiss="modal"
                                                                aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body m-3">
                                                            <div class="container w-100">
                                                                <% user.wallet.transactionHistory.forEach(transaction=>
                                                                    { %>
                                                                    <div class="row">
                                                                        <div class="col-md-6">
                                                                            <p class="text-dark">
                                                                                <%= transaction.direction %> to <%=
                                                                                        transaction.type %>
                                                                            </p>
                                                                            <p>
                                                                                <%= transaction.transactionDate %>
                                                                            </p>
                                                                            <p>Transaction id : <%= transaction._id %>
                                                                            </p>
                                                                        </div>
                                                                        <div class="col-md-6 d-flex justify-content-end align-items-center"
                                                                            style="text-align: end;">
                                                                            <h6
                                                                                class="<%= transaction.direction === 'paid' ? 'text-danger' : 'text-success' %>
                                                                            <%= transaction.direction === 'Paid' ? 'text-danger' : 'text-success' %>">
                                                                                <%= transaction.direction==='Recieved'
                                                                                    ? '+' : '-' %>
                                                                                    <%= transaction.amount %>
                                                                            </h6>
                                                                        </div>
                                                                    </div>
                                                                    <hr class=" my-2"
                                                                        style="border-top: 1px solid #8e8e8e;">
                                                                    <% }); %>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>


                                            <div class="tab-pane fade" id="tab-coupons" role="tabpanel"
                                                aria-labelledby="tab-coupons-link">
                                                <p><u>How to use?</u> : <span class="text-primary">copy the
                                                        <strong><i>Coupon id</i></strong> and paste in your cart
                                                        apply coupon field.</span></p>
                                                <div class="row pl-4">
                                                    <% coupons.forEach(coupon=>{ %>
                                                        <div class="col-md-4 mt-3">
                                                            <div class="card couponCard shadow text-center"
                                                                style="background-image:url(/assets/couponBgImages/<%=coupon.bgImage%>);">
                                                                <div class="card-body background p-0">
                                                                    <div class="white-body bg-light p-4"
                                                                        style="opacity: 0.8; border: 5px double #c96; box-sizing: border-box; padding: 10px; max-height: 28rem;">
                                                                        <h6>Discount upto</h6>
                                                                        <h1>
                                                                            <%=coupon.discountPercentage%>%
                                                                        </h1>
                                                                        <h6>-off-</h6>
                                                                        <p>
                                                                            <%=coupon.description%>
                                                                        </p>
                                                                        <h5>
                                                                            <%=coupon.couponId%>
                                                                        </h5>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <% }); %>

                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- .End .tab-pane -->
                                </div> <!-- col -->
                            </div><!-- End .row -->
                        </div><!-- End .container -->
                    </div><!-- End .dashboard -->
        </div><!-- .End .page-content -->
        </main><!-- End .main -->





        <!-- -----------------Address deletion Modal------------ -->
        <!-- Modal -->
        <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
                        <i data-bs-dismiss="modal" class="fa-light fa-x " style="color: #000000;"></i>
                    </div>
                    <div class="modal-body pl-3">
                        Are you sure you want to Delete this address?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="confirmDeleteAddress()">Remove</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- ----------------ADD-ADDress-Modal------ -->
        <div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog" aria-labelledby="addAddressModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addAddressModalLabel">Add Address</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modalbody p-4">
                        <form id="addressForm">
                            <!-- Form fields go here -->
                            <div class="form-group">
                                <label for="name">Name*</label>
                                <p class="text-danger d-inline" id="nameError"></p>
                                <input type="text" class="form-control" id="name" name="name">
                            </div>

                            <div class="form-group">
                                <label for="company">Company Name(optional)</label>
                                <input type="text" class="form-control" id="company" name="company">
                            </div>

                            <div class="form-group">
                                <label for="country">Country*</label>
                                <p class="text-danger d-inline" id="countryError"></p>
                                <input type="text" class="form-control" id="country" name="country">
                            </div>

                            <div class="form-group">
                                <label for="street">Street Address*</label>
                                <input type="text" class="form-control" id="houseNo" name="houseName"
                                    placeholder="House number and street name">
                            </div>

                            <div class="form-group">
                                <input type="text" class="form-control" id="appartment" name="appartment"
                                    placeholder="Apartments, suite, unit, etc..">
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="city">Town/City*</label>
                                    <input type="text" class="form-control" id="city" name="city">
                                </div>

                                <div class="form-group col-md-6">
                                    <label for="state">State*</label>
                                    <input type="text" class="form-control" id="state" name="state">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6 ">
                                    <label for="postcode">Postcode/zip*</label>
                                    <p class="text-danger d-inline" id="postcodeError"></p>
                                    <input type="text" class="form-control" id="postcode" name="postcode">
                                </div>

                                <div class="form-group col-md-6">
                                    <label for="phone">Phone*</label>
                                    <p class="text-danger d-inline" id="phoneError"></p>
                                    <input type="text" class="form-control" id="phone" name="phone">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="email">Email Address*</label>
                                <p class="text-danger d-inline" id="emailError"></p>
                                <input type="" class="form-control" id="email" name="email">
                            </div>

                            <div class="form-group">
                                <input type="checkbox" id="default" value="true" name="default" class="bg-primary">
                                <label for="">Default address</label>
                            </div>

                            <div class="form-group text-center ">
                                <button type="submit" class="btn btn-primary rounded">Save Address</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Address Modal -->
        <div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <!-- Form fields for editing address details go here -->
                        <form id="editAddressForm">
                            <div class="mb-3">
                                <label for="editName" class="form-label">Name*</label>
                                <p class="text-danger d-inline" id="nameError"></p>
                                <input type="text" class="form-control" id="name" name="name">
                            </div>
                            <div class="mb-3">
                                <label for="editCompany" class="form-label">Company Name (optional)</label>
                                <input type="text" class="form-control" id="company" name="company">
                            </div>
                            <div class="mb-3">
                                <label for="editCountry" class="form-label">Country*</label>
                                <p class="text-danger d-inline" id="countryError"></p>
                                <input type="text" class="form-control" id="country" name="country">
                            </div>
                            <!-- Repeat for other address fields -->
                            <div class="mb-3">
                                <!-- Add other fields as needed -->
                                <label for="editStreet" class="form-label">Street Address*</label>
                                <input type="text" class="form-control" id="houseName" name="houseName"
                                    placeholder="House number and street name">
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="appartment" name="appartment"
                                    placeholder="Apartments, suite, unit, etc..">
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="editCity">Town/City*</label>
                                    <input type="text" class="form-control" id="city" name="city">
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="editState">State*</label>
                                    <input type="text" class="form-control" id="state" name="state">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="editPostcode">Postcode/ZIP*</label>
                                    <p class="text-danger d-inline" id="postcodeError"></p>
                                    <input type="text" class="form-control" id="postcode" name="postcode">
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="editPhone">Phone*</label>
                                    <p class="text-danger d-inline" id="phoneError"></p>
                                    <input type="text" class="form-control" id="phone" name="addressId">
                                </div>

                                <input type="text" class="form-control" style="display: none;" id="addressId"
                                    name="addressId">

                            </div>

                            <div class="form-group">
                                <label for="editEmail">Email Address*</label>
                                <p class="text-danger d-inline" id="emailError"></p>
                                <input type="" class="form-control" id="email" name="email">
                            </div>

                            <div class="form-group">
                                <input type="checkbox" id="isdefault" name="isDefault">
                                <label for="default">Default address</label>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary rounded"
                                    data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary rounded">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="notification-container"></div>


        <!-- Plugins JS File -->
        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.bundle.min.js"></script>
        <script src="/assets/js/jquery.hoverIntent.min.js"></script>
        <script src="/assets/js/jquery.waypoints.min.js"></script>
        <script src="/assets/js/superfish.min.js"></script>
        <script src="/assets/js/owl.carousel.min.js"></script>
        <!-- Main JS File -->
        <script src="/assets/js/main.js"></script>




        <!-- --------------Refund request------------- -->
        <script>
            function refundRequest(orderId, productId) {
                Swal.fire({
                    title: 'Are you sure?',
                    html: 'Do you want to send a refund request for this order? <br><br><span style="color: red;">NB: If you got the coupon, it will be deducted</span>',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#7ac093',
                    confirmButtonText: 'Yes, send refund request!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#refundRequestModal').modal({
                            backdrop: 'static',
                            keyboard: false
                        }).modal('show');

                        $('#refundRequestModal').on('hidden.bs.modal', function () {
                            location.reload();
                        });

                        $('#refundRequestModal form').submit(function (event) {
                            event.preventDefault();

                            const formData = new FormData(this);
                            formData.append('orderId', orderId);
                            formData.append('productId', productId);

                            $.ajax({
                                url: '/account/refundRequest',
                                type: 'POST',
                                data: formData,
                                contentType: false,
                                processData: false,
                                success: function (response) {
                                    console.log(response);
                                    if (response.success) {
                                        Swal.fire({
                                            title: 'Refund request sent!',
                                            text: "We'll review your request and get back to you shortly.",
                                            icon: 'success'
                                        }).then(() => {
                                            $('#refundRequestModal').modal('hide');
                                            location.reload();
                                        });

                                    } else {
                                        Swal.fire({
                                            title: 'Oops!',
                                            text: response.message || 'There was an error processing your request. Please try again.',
                                            icon: 'error'
                                        });
                                    }
                                },
                                error: function (error) {
                                    Swal.fire({
                                        title: 'Oops!',
                                        text: 'There was an error sending your request. Please check your internet connection and try again.',
                                        icon: 'error'
                                    });
                                }
                            });

                        });
                    }
                });
            }
            //    -----------showing image on div--------[]
            const input = document.querySelector('.col-md-6 input[type="file"]');
            const image = document.querySelector('.col-md-6 img');

            input.addEventListener('change', (event) => {
                const file = event.target.files[0];

                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        image.src = event.target.result;
                        image.style.width = '100%';
                        image.style.height = '100%';
                        image.style.objectFit = 'cover';
                    };
                    reader.readAsDataURL(file);
                } else {

                    image.src = '/assets/images/icons/imageUploader.png';
                    image.style.width = 'auto';
                    image.style.height = 'auto';
                }
            });


        </script>
        <!-- -------order cancelation-------- -->
        <script>
            function cancelOrder(productId, orderId) {
                Swal.fire({
                    title: 'Are you sure?',
                    html: 'Do you want to cancel this order!<br><br><span style="color: red;">NB: If you got the coupon, it will be deducted</span>',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#7ac093',
                    confirmButtonText: 'Yes, cancel Order!'
                }).then((result) => {
                    if (result.isConfirmed) {

                        fetch(`/account/cancelOrderItem`, {
                            method: 'DELETE',
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ productId, orderId })
                        })
                            .then(response => response.json())
                            .then(data => {

                                if (data.success) {
                                    $('#tab-orders').load('/account #tab-orders');
                                    Swal.fire('Cancelled!', 'Your order has been cancelled.', 'success');
                                }
                            })

                    } else {
                        Swal.fire('Cancel failed!', 'Something went wrong.', 'failed');

                    }
                });
            }

        </script>


        
    <!-- Add this script to your HTML -->
    <script>
        $(document).on('click', '.product-name', function () {
            var productImage = $(this).data('product-image');
            var productName = $(this).data('product-name');
            var productQuantity = $(this).data('product-quantity');
            var purchaseDate = $(this).data('purchase-date');
            var totalAmount = $(this).data('total-amount');
            var paymentMethod = $(this).data('payment-method');
            var status = $(this).data('status');
            var productAmount = $(this).data('product-amount');
            var name = $(this).data('name');
            var houseName = $(this).data('house-name');
            var zipcode = $(this).data('zipcode');
            var phone = $(this).data('phone');
            var statusUpdateDate = $(this).data('status-update-date');



            // Set the modal content dynamically
            $('#modal-product-image').attr('src', "/assets/productImages/uploadImages/" + productImage);
            $('#modal-product-quantity').text(productQuantity);
            $('#modal-product-name').text(productName);
            $('#modal-purchase-date').text(purchaseDate);
            $('#modal-total-amount').text(totalAmount);
            $('#modal-payment-method').text(paymentMethod);
            $('.modal-status').text(status);
            $('#modal-product-amount').text(productAmount);
            $('#modal-house-name').text(houseName);
            $('#modal-name').text(name);
            $('#modal-zipcode').text(zipcode);
            $('#modal-phone').text(phone);
            $('#modal-status-update-date').text(statusUpdateDate);
        });
    </script>


        <!-- ----------------Edit Addres-------------------- -->
        <script>
            function showEditAddressModal(name, company, country, houseName, appartmentNumber, city, state, postcode, phone, email, addressId, isDefault) {

                var form = document.getElementById('editAddressForm');
                form.querySelector('#name').value = name;
                form.querySelector('#email').value = email;
                form.querySelector('#phone').value = phone;
                form.querySelector('#city').value = city;
                form.querySelector('#state').value = state;
                form.querySelector('#postcode').value = postcode;
                form.querySelector('#company').value = company;
                form.querySelector('#country').value = country;
                form.querySelector('#houseName').value = houseName
                form.querySelector('#appartment').value = appartmentNumber;
                form.querySelector('#addressId').value = addressId;


                var defaultCheckbox = form.querySelector('#isdefault');

                if (isDefault == "true") {
                    defaultCheckbox.checked = true;
                } else {
                    defaultCheckbox.checked = false
                }

                // Show the modal
                $('#editAddressModal').modal('show');
            }
        </script>


        <!-- -------------------DeleteAddress------------- -->
        <script>
            function showConfirmationModal(addressId) {
                $('#confirmationModal').data('addressId', addressId);
                $('#confirmationModal').modal('show');
            }

            function confirmDeleteAddress() {
                const addressId = $('#confirmationModal').data('addressId');

                fetch(`/account/deleteAddress`, {
                    method: 'DELETE',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ addressId })
                })
                    .then(response => response.json())
                    .then(result => {
                        console.log(result);

                        $('#addressTab').load('/account #addressTab', function () {
                            if (result.success) {
                                showNotification(result.message, true);
                            } else {
                                showNotification(result.message, false);
                            }
                        });
                    })
                    .catch(error => console.error('Error Deleting Address:', error));

                $('#confirmationModal').modal('hide');
            }
        </script>



        <!-- ------------------display USer Dp----------------- -->
        <script>
            function displayImage() {
                var fileInput = document.getElementById('fileInput');
                var profileImage = document.getElementById('profileImage');

                // Check if a file is selected
                if (fileInput.files && fileInput.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {

                        profileImage.src = e.target.result;
                    };

                    // Read the data URL of the selected file
                    reader.readAsDataURL(fileInput.files[0]);
                }
            }
        </script>

        <!-- JavaScript Validation of EDIT USER -->
        <script>
            function validateForm(formId) {
                var form = document.getElementById(formId);


                var name = form.querySelector('#name');
                var email = form.querySelector('#email');
                var phone = form.querySelector('#phone');
                var nameError = form.querySelector('#nameError');
                var emailError = form.querySelector('#emailError');
                var phoneError = form.querySelector('#phoneError');

                // Regular expressions for validation
                var nameRegex = /^[A-Za-z\s]{4,}$/;
                var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                var phoneRegex = /^\d{10}$/;
                var countryRegex = /^\D*$/;

                // Validate Name
                if (!nameRegex.test(name.value)) {
                    nameError.textContent = 'Name should contain at least 4 letters and no digits.';
                    return false;
                } else {
                    nameError.textContent = '';
                }

                if (!emailRegex.test(email.value)) {
                    emailError.textContent = 'Invalid email format.';
                    return false;
                } else {
                    emailError.textContent = '';
                }

                if (!phoneRegex.test(phone.value)) {
                    phoneError.textContent = 'Phone should contain 10 digits.';
                    return false;
                } else {
                    phoneError.textContent = '';
                }


                if (formId === 'addressForm' || formId === 'editAddressForm') {
                    var postCodeRegex = /^\d{6}$/;
                    var country = form.querySelector('#country');
                    var postcode = form.querySelector('#postcode');
                    var postError = form.querySelector('#postcodeError');
                    var countryError = form.querySelector('#countryError');


                    if (!countryRegex.test(country.value)) {
                        countryError.textContent = 'Invalid country name';
                        return false;
                    } else {
                        countryError.textContent = '';
                    }

                    if (!postCodeRegex.test(postcode.value)) {
                        postError.textContent = 'It should only contain 6 digits';
                        return false;
                    } else {
                        postError.textContent = '';
                    }
                }

                return true;
            }

        </script>

        <!------------showing notification------------->
        <script>
            function showNotification(message, success = true) {
                const notificationContainer = document.getElementById('notification-container');
                notificationContainer.innerHTML = message;

                if (success) {
                    notificationContainer.style.color = 'green';
                } else {
                    notificationContainer.style.color = 'red';
                }

                notificationContainer.style.display = 'block';

                setTimeout(() => {
                    notificationContainer.style.display = 'none';
                }, 3000);
            }


            // ------------for Edit User-----------
            document.getElementById('editform').addEventListener('submit', async function (event) {
                event.preventDefault();

                if (!validateForm('editform')) {
                    return;
                }

                const form = event.target;
                const formData = new FormData(form);

                const response = await fetch(form.action, {
                    method: form.method,
                    body: formData,
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, true);
                } else {
                    showNotification(result.message, false);
                }
            });

            // ------------for add address-----------
            $('#addressForm').submit(async function (event) {
                event.preventDefault();

                if (!validateForm('addressForm')) {
                    return;
                }

                const formData = new FormData(this);
                const formObj = Object.fromEntries(Array.from(formData.entries()));

                const defaultAddressCheckbox = $('#default');
                formObj.isDefault = defaultAddressCheckbox.prop('checked');

                try {
                    const response = await $.ajax({
                        url: '/account/addAddress',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(formObj),
                    });

                    const result = response;

                    if (result.success) {
                        $('#addressTab').load('/account #addressTab', function () {
                            $('#addAddressModal').modal('hide');
                            showNotification(result.message, true);
                        });
                    } else {
                        $('#addressTab').load('/account #addressTab', function () {
                            $('#addAddressModal').modal('hide');
                            showNotification(result.message, false);
                        });
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });


            //  ------For edit ADdress------
            $('#editAddressForm').submit(async function (event) {
                event.preventDefault();

                if (!validateForm('editAddressForm')) {
                    return;
                }

                const formData = new FormData(this);
                const formObj = Object.fromEntries(Array.from(formData.entries()));

                const defaultAddressCheckbox = $('#isdefault');
                console.log("Checkbox checked:", defaultAddressCheckbox.is(':checked'));
                formObj.isDefault = defaultAddressCheckbox.is(':checked');

                try {
                    const response = await $.ajax({
                        url: '/account/editAddress',
                        method: 'PATCH',
                        contentType: 'application/json',
                        data: JSON.stringify(formObj),
                    });

                    const result = response;

                    if (result.success) {
                        $('#addressTab').load('/account #addressTab', function () {
                            $('#editAddressModal').modal('hide');
                            showNotification(result.message, true);
                        });
                    } else {
                        $('#addressTab').load('/account #addressTab', function () {
                            $('#editAddressModal').modal('hide');
                            showNotification(result.message, false);
                        });
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });

        </script>

        <!-- -----show date on orders------ -->
        <script>
            function formatDate(dateString) {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return new Date(dateString).toLocaleDateString('en-US', options);
            }
        </script>

<script>
    document.querySelector(".btn-print").addEventListener("click", function() {
      var modal = document.getElementById("orderDetailsModal");
      var modalBody = modal.querySelector(".modal-body");
  
      var printWindow = window.open('', '_blank');
      
      printWindow.document.write('<html><head><title>Order invoice</title></head><body>');
      printWindow.document.write('<div style="font-family: sans-serif;">');
      printWindow.document.write(modalBody.innerHTML);
      printWindow.document.write('</div></body></html>');
      printWindow.document.close();
      
      printWindow.print();
    });
  </script>
  
        <%-include('../layouts/user/footer')-%>
